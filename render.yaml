services:
  - type: web
    name: feedback-app
    runtime: python
    plan: free
    buildCommand: |
      pip install -r requirements.txt
      python manage.py migrate
      python manage.py collectstatic --no-input
    startCommand: |
      # SUPERUSER CREATION WITH ERROR HANDLING
      python manage.py shell -c "
      import os
      from django.contrib.auth.models import User
      
      username = os.environ.get('ADMIN_USERNAME', 'admin')
      email = os.environ.get('ADMIN_EMAIL', 'admin@example.com')
      password = os.environ.get('ADMIN_PASSWORD')
      
      print(f'üîÑ Attempting to create superuser: {username}')
      
      if not User.objects.filter(is_superuser=True).exists():
          if password:
              try:
                  # Method 1: Try normal way
                  User.objects.create_superuser(username, email, password)
                  print(f'‚úÖ Superuser {username} created')
              except Exception as e:
                  print(f'‚ö†Ô∏è  Normal creation failed: {e}')
                  print('üí° Trying manual creation...')
                  
                  # Method 2: Manual creation (bypasses validation)
                  try:
                      user = User.objects.create_user(
                          username=username,
                          email=email,
                          password=None,
                          is_superuser=True,
                          is_staff=True,
                          is_active=True
                      )
                      user.set_password(password)
                      user.save()
                      print(f'‚úÖ Superuser {username} created (manual)')
                  except Exception as e2:
                      print(f'‚ùå Manual creation failed: {e2}')
          else:
              print('‚ùå ADMIN_PASSWORD not set in environment')
      else:
          print('‚úÖ Superuser already exists')
      "
      gunicorn main.wsgi:application
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: feedback-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: feedback-app.onrender.com
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: ADMIN_USERNAME
        value: admin
      - key: ADMIN_EMAIL
        value: admin@example.com
      - key: ADMIN_PASSWORD
        sync: false  # YOU MUST SET THIS MANUALLY IN RENDER DASHBOARD
    healthCheckPath: /
    autoDeploy: true

databases:
  - name: feedback-db
    databaseName: feedback-db
    plan: free
